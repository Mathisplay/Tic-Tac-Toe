<!Doctype HTML>
<html>
	<head>
		<title>Najlepsza strona na świecie.</title>
		<meta name="author" content="Mathis" />
		<meta name="keywords" content="Strona" />
		<meta name="description" content="Naprawdę." />
		<meta name="viewport" content="
		initial-scale=1.0,
		maximum-scale=1.0,
		width=device-width,
		user-scalable=no,
		target-densitydpi=device-dpi
		" />
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<script type="text/javascript" src="js/main.js"></script>
		<script src="https://www.games.it-k.pl/js/tictactoeconn.js"></script>
	</head>
	<body onresize="popraw()">
		<div id="Canvas">
			<canvas id="Canvas1" class="One"></canvas>
			<div class="Text1">
				<p class="Czcionka1">Tic-Tac-Toe</p>
			</div>
			<div class="Text2">
				<p id="Kto" class="Czcionka2"></p>
			</div>
			<div class="Text3">
				<p id="Kolko" class="Czcionka2">O: 0</p>
			</div>
			<div class="Text4">
				<p id="Krzyzyk" class="Czcionka2">X: 0</p>
			</div>
			<div class="Text5">
				<p id="Tura" class="Czcionka2">TURA O</p>
			</div>
			<div class="Text6">
				<p id="Tura" class="Czcionka3">Made by Mathis</p>
			</div>
			<div class="Text7">
				<p id="Ja" class="Czcionka4">JA</p>
			</div>
			<div class="Text8">
				<p id="Przeciwnik" class="Czcionka4">PRZECIWNIK</p>
			</div>
		</div>
		
		
		
		<script>
		//obsluga okienka
		var c = document.getElementById("Canvas1");
		var ctx = c.getContext("2d");		
			
		//wymiary canvas
		var wid = parseInt(window.innerWidth * 9 / 10);
		var hei = parseInt(window.innerHeight * 9 / 10);
			
		//ustaw wymiary canvas
		c.width = window.innerWidth * 9 / 10;
		c.height = window.innerHeight * 9 / 10;
			
		//po jakiej wartości rysować obiekty
		var okienko;
		if(c.width > c.height)
		{
			okienko = hei;
		}
		else
		{
			okienko = wid;
		}
		//gra
		var ruch;
		var tura = 0;
		var xy = [];
		var play = [];
		
		function displayField(data)
		{
			/*
			Tutaj kod wyświetlający kóło i krzyżyk

			Co zawiera objekt data:

			data.nick - nazwa zalogowanego gracza

			data.nickopp - nazwa przeciwnika

			data.conf - Symbol gracza: 1 - kółko, 2 - krzyżyk

			data.field - tablica 9 elementowa pól: 0 - brak, 1 - kółko, 2 - krzyżyk 
			(od górnego lewego rogu chyba, ale jak wygodniej to nie ma znaczenia)

			data.score - tablica wyników: data.score[0] - wynik gracza zalogowanego, data.score[1] - wynik przeciwnika
			data.status - status gry: 0 - trwa, 1 - wygrało kółko, 2 - wygrał krzyżyk, 3 - nikt nie wygrał

			Gdy data.status == 0:
				data.is_move - jeżeli 1 to ruch gracza, jeżeli 0 to ruch przeciwnika

			Gdy data.status != 0:
				data.is_invite - jeżeli 0 to nie ma zaproszenia, jeżeli 1 to jest zaproszenie od przeciwnika
					wtedy można akceptować grę

			tictactoeConn.move(pos);
			pos to wartość int od 0 do 8 oznaczające pole, które wybrał gracz na planszy
			wysła do serwera ruch gracza

			tictactoeConn.invite();
			wysyła do przeciwnika zaproszenie do następnej gry z serii

			tictactoeConn.accept();
			akceptuje zaproszenie do gry
			*/
			ruch = data.is_move;
			var jaNick = data.nick;
			var oppNick = data.nickopp;
			var czymGram = data.conf;
			
			if(czymGram == 1)
			{
				if(ruch == 1)
				{
					document.getElementById("Tura").innerHTML = "TURA O";
				}
				else
				{
					document.getElementById("Tura").innerHTML = "TURA X";
				}
			}
			else
			{
				if(ruch == 1)
				{
					document.getElementById("Tura").innerHTML = "TURA X";
				}
				else
				{
					document.getElementById("Tura").innerHTML = "TURA O";
				}
			}
			
			if(czymGram == 1)
			{
				document.getElementById("Kolko").innerHTML = "O: " + data.score[0];
				document.getElementById("Krzyzyk").innerHTML = "X: " + data.score[1];
			}
			else
			{
				document.getElementById("Kolko").innerHTML = "X: " + data.score[0];
				document.getElementById("Krzyzyk").innerHTML = "O: " + data.score[1];
			}
			
			document.getElementById("Ja").innerHTML = jaNick;
			document.getElementById("Przeciwnik").innerHTML = oppNick;
			console.log(data.nick);//Wyświetla w konsoli nazwę gracza
			console.log(data.score[0]);//Wyświetla w konsoli wynik gracza
			console.log(data.field);
			play = data.field;
			popraw();
		}
		tictactoeConn.init(displayField);
		
		function which(xmo, ymo)
		{
			//uzupełnianie przy klikaniu
			for(var i = 0; i < xy.length; i = i + 4)
			{
				if((xmo >= xy[i]) && (ymo >= xy[i + 1]) && (xmo <= xy[i + 2]) && (ymo <= xy[i + 3]))
				{
					//jak nic jeszcze nie ma
					if(ruch == 1)
					{	
						tictactoeConn.move(i / 4);
						popraw();
					}
				}
			}
		}
			
		//obsługa kliknięć na pola
		window.addEventListener("click", function()
		{
			/*if(contin == 1)
				{
				resetField();
				contin = 0;
				win = 0;
			}*/
			if(ruch == 1)
			{
				var x = event.clientX - Canvas1.offsetLeft;
				var y = event.clientY - Canvas1.offsetTop;
				which(x, y);
			}
		});

		function popraw()
		{
			//reset danych okna
			c.width = window.innerWidth * 9 / 10;
			c.height = window.innerHeight * 9 / 10;
			wid = parseInt(window.innerWidth * 9 / 10);
			hei = parseInt(window.innerHeight * 9 / 10);
			xy.length = 0;
			if(c.width > c.height)
			{
				okienko = hei;
			}
			else
			{
				okienko = wid;
			}

			//czyszczenie okna
			ctx.beginPath();
			ctx.clearRect(0, 0, wid, hei);
			ctx.stroke();
				
			//narysuj siatkę i uzupełnij współrzędne
			for(var i = 1; i < 4; i++)
			{
				for(var j = 1; j < 4; j++)
				{
					var a = ((wid / 2) - (okienko / 5 * 2.5) + (j * (okienko / 5)));
					var b = ((hei / 2) - (okienko / 5 * 2.5) + (i * (okienko / 5)));
					xy.push(a + 5);
					xy.push(b + 5);
					xy.push(a + okienko / 5 - 5);
					xy.push(b + okienko / 5 - 5);
					ctx.beginPath();
					ctx.lineWidth="10";
					ctx.strokeStyle="#65676B";
					ctx.rect((wid / 2) - (okienko / 5 * 2.5) + (j * (okienko / 5)) + 4, (hei / 2) - (okienko / 5 * 2.5) + (i * (okienko / 5)) + 4, (okienko / 5), (okienko / 5));
					ctx.stroke();
				}
			}

			//dalej siatka
			for(var i = 1; i < 4; i++)
			{
				for(var j = 1; j < 4; j++)
				{
					var a = ((wid / 2) - (okienko / 5 * 2.5) + (j * (okienko / 5)));
					var b = ((hei / 2) - (okienko / 5 * 2.5) + (i * (okienko / 5)));
					ctx.beginPath();
					ctx.lineWidth="10";
					ctx.strokeStyle="white";
					ctx.rect((wid / 2) - (okienko / 5 * 2.5) + (j * (okienko / 5)), (hei / 2) - (okienko / 5 * 2.5) + (i * (okienko / 5)), (okienko / 5), (okienko / 5));
					ctx.stroke();
				}
			}

			//uzupełnij kółka i krzyżyki
			for(var i = 0; i < xy.length; i = i + 4)
			{
				if(play[i / 4] == 1)
				{
					ctx.beginPath();
					ctx.lineWidth="10";
					ctx.strokeStyle="#65676B";
					ctx.arc((xy[i] + xy[i + 2]) / 2 + 2, (xy[i + 1] + xy[i + 3]) / 2 + 4, (xy[i + 3] - xy[i + 1]) / 2 - 14, 0, 2 * Math.PI);
					ctx.stroke();					
					ctx.beginPath();
					ctx.lineWidth="10";
					ctx.strokeStyle="white";
					ctx.arc((xy[i] + xy[i + 2]) / 2, (xy[i + 1] + xy[i + 3]) / 2, (xy[i + 3] - xy[i + 1]) / 2 - 14, 0, 2 * Math.PI);
					ctx.stroke();
				}
				else if(play[i / 4] == 2)
				{
					ctx.beginPath();
					ctx.lineWidth="10";
					ctx.strokeStyle="#65676B";
					ctx.moveTo(xy[i] + 14, xy[i + 1] + 18);
					ctx.lineTo(xy[i + 2] - 14, xy[i + 3] - 10);
					ctx.moveTo(xy[i + 2] - 10, xy[i + 1] + 16);
					ctx.lineTo(xy[i] + 18, xy[i + 3] - 12);
					ctx.stroke();			
					ctx.beginPath();
					ctx.lineWidth="10";
					ctx.strokeStyle="white";
					ctx.moveTo(xy[i] + 14, xy[i + 1] + 14);
					ctx.lineTo(xy[i + 2] - 14, xy[i + 3] - 14);
					ctx.moveTo(xy[i + 2] - 14, xy[i + 1] + 14);
					ctx.lineTo(xy[i] + 14, xy[i + 3] - 14);
					ctx.stroke();
				}
			}
		}
		popraw();
		</script>
	</body>
</html>
